<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8" />
<meta name="viewport"
	content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no" />
<title>budongsan</title>
<script src="https://code.jquery.com/jquery-1.12.4.min.js"
	integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ="
	crossorigin="anonymous"></script>
<script type="text/javascript"
	src="https://openapi.map.naver.com/openapi/v3/maps.js?ncpClientId=0rm45zpj5b"></script>
<script type="text/javascript" th:src="@{/js/MarkerClustering.js}"></script>
<script type="text/javascript" th:src="@{/js/map_data.js}"></script>
<link rel='stylesheet' th:href='@{/css/map.css}' type='text/css' />
<script th:inline="javascript">
    var clusterMarkerImagePath = /*[[@{/assets/images/}]]*/ '../static/assets/images/';
</script>
</head>
<body>
	<div class="navbar">
		<div class="navContent" id="homeIcon">
			<img th:src="@{/assets/images/home.png}" />
		</div>
		<div class="navContent" id="commIcon">
            <img th:src="@{/assets/images/comm.png}" />
        </div>
        <div class="navContent" id="userIcon">
            <img th:src="@{/assets/images/user.png}" />
        </div>
	</div>
	<div id="map"></div>
	<div class="menu" id="homeMenu">
		<div class="closeMenu"><img th:src="@{/assets/images/close_menu.png}" class='closeMenuImg'/></div>
		<div th:include="home :: content"></div>
	</div>
	<div class="menu" id="commMenu">
        <div class="closeMenu">
            <img th:src="@{/assets/images/close_menu.png}" class='closeMenuImg'/>
        </div>
    </div>
    <div class="menu" id="userMenu">
        User Menu Content
        <div class="closeMenu">
            <img th:src="@{/assets/images/close_menu.png}" class='closeMenuImg'/>
        </div>
    </div>
    <div class="menu" id="aptInfo"></div>
    
    <div id="closeBtnTemplate" style="display:none;">
        <div class="closeMenu">
            <img th:src="@{/assets/images/close_menu.png}" class='closeMenuImg' />
        </div>
    </div>

	<script>
		var map = new naver.maps.Map("map", {
			zoom : 11,
			center : new naver.maps.LatLng(37.5664056, 126.9778222),
			zoomControl : true,
			zoomControlOptions : {
				position : naver.maps.Position.TOP_RIGHT,
				style : naver.maps.ZoomControlStyle.SMALL,
			},
		});

		var markers = [], data = mapData.mapData2;

		for (var i = 0, ii = data.length; i < ii; i++) {
			var spot = data[i];

			if (spot.grd_la !== null && spot.grd_lo !== null) {
				var latlng = new naver.maps.LatLng(spot.LAT, spot.LNG);
				var apt = spot.COMPLEX_NAME;
				var price = spot.SALE_PRICE;
				var estateId = spot.REAL_ESTATE_ID;
				var marker = new naver.maps.Marker({
					position : latlng,
					draggable : false,
					clickable : true,
					icon : {
						content : [ '<div class="marker_container">',
								'<span><strong>' + apt + '</strong>('+price+'억)</span>',
								'<div class="disabled" style="display:none;">'+estateId+'</div>',
								'</div>' ].join(''),
						size : new naver.maps.Size(40, 40),
						anchor : new naver.maps.Point(20, 20)
					}
				});

				markers.push(marker);

				// 마커 클릭 이벤트 핸들러 추가
				// 마커 클릭 이벤트 핸들러 추가
				naver.maps.Event.addListener(marker, 'click', function(e) {
				    var clickedMarker = e.overlay;
				    var clickedApt = $(clickedMarker.getIcon().content).find('strong').text();
				    var ClickedId = $(clickedMarker.getIcon().content).find('.disabled').text();
				    
				    // 아파트 이름을 기준으로 REAL_ESTATE_ID를 찾는 함수 호출
				    /* var realEstateId = getRealEstateId(clickedApt); */ 

				    // 메뉴 내용을 클릭된 마커 정보로 업데이트 (realEstateId를 사용하도록 수정)
				    $('#aptInfo').html(
				        '<p>Clicked Marker Information</p><p>Apt: ' + clickedApt + '</p><p>Real Estate ID: ' + ClickedId + '</p>');

				    // 모든 메뉴를 닫고 aptInfo 메뉴를 열기
				    $('.menu').removeClass('active');
				    $('#aptInfo').addClass('active');

				    // 닫기 버튼 추가 
				    var closeBtn = $('#closeBtnTemplate').html();
				    $('#aptInfo').prepend(closeBtn);

				    // 닫기 버튼에 클릭 이벤트 추가
				    $('.closeMenuImg').click(function() {
				        $('#aptInfo').removeClass('active');
				        $(this).remove(); // 닫기 버튼 제거
				    });
				});


			}
		}

		var htmlMarker1 = {
			    content: '<div style="cursor:pointer;width:40px;height:40px;line-height:42px;font-size:10px;color:white;text-align:center;font-weight:bold;background-image:url(' + clusterMarkerImagePath + 'cluster-marker-1.png);background-size:contain;"></div>',
			    size: N.Size(40, 40),
			    anchor: N.Point(20, 20)
			}, htmlMarker2 = {
			    content: '<div style="cursor:pointer;width:40px;height:40px;line-height:42px;font-size:10px;color:white;text-align:center;font-weight:bold;background-image:url(' + clusterMarkerImagePath + 'cluster-marker-2.png);background-size:contain;"></div>',
			    size: N.Size(40, 40),
			    anchor: N.Point(20, 20)
			}, htmlMarker3 = {
			    content: '<div style="cursor:pointer;width:40px;height:40px;line-height:42px;font-size:10px;color:white;text-align:center;font-weight:bold;background-image:url(' + clusterMarkerImagePath + 'cluster-marker-3.png);background-size:contain;"></div>',
			    size: N.Size(40, 40),
			    anchor: N.Point(20, 20)
			}, htmlMarker4 = {
			    content: '<div style="cursor:pointer;width:40px;height:40px;line-height:42px;font-size:10px;color:white;text-align:center;font-weight:bold;background-image:url(' + clusterMarkerImagePath + 'cluster-marker-4.png);background-size:contain;"></div>',
			    size: N.Size(40, 40),
			    anchor: N.Point(20, 20)
			}, htmlMarker5 = {
			    content: '<div style="cursor:pointer;width:40px;height:40px;line-height:42px;font-size:10px;color:white;text-align:center;font-weight:bold;background-image:url(' + clusterMarkerImagePath + 'cluster-marker-5.png);background-size:contain;"></div>',
			    size: N.Size(40, 40),
			    anchor: N.Point(20, 20)
			};

		var markerClustering = new MarkerClustering({
			minClusterSize : 2,
			maxZoom : 18,
			map : map,
			markers : markers,
			disableClickZoom : false,
			gridSize : 100,
			icons : [ htmlMarker1, htmlMarker2, htmlMarker3, htmlMarker4,
					htmlMarker5 ],
			indexGenerator : [ 10, 100, 200, 500, 1000 ],
			stylingFunction : function(clusterMarker, count) {
				$(clusterMarker.getElement()).find("div:first-child").text(
						count);
			}
		});

		$(document).ready(function() {
		    function toggleMenu(iconId, menuId) {
		        $("#" + iconId).click(function() {
		            var isActive = $("#" + menuId).hasClass("active");

		            $(".menu").removeClass("active");
		            $(".closeMenu").removeClass("active");

		            if (!isActive) {
		                $("#" + menuId).addClass("active");
		                $("#" + menuId).find(".closeMenu").addClass("active"); // 메뉴가 열릴 때 closeMenu 버튼 활성화
		            }
		        });

		        // closeMenu 버튼에 클릭 이벤트 추가
		        $("#" + menuId).find(".closeMenu").click(function() {
		            $("#" + menuId).removeClass("active"); // 메뉴 닫기
		            $(this).removeClass("active"); // closeMenu 버튼 비활성화
		        });
		    }

		    toggleMenu("homeIcon", "homeMenu");
		    toggleMenu("commIcon", "commMenu");
		    toggleMenu("userIcon", "userMenu");
		});

 

		$(document).ready(function() {
			
			// 페이지네이션 생성 함수
			function createPagination(currentPage, total, pageSize) {
			    var pageCount = Math.ceil(total / pageSize);
			    var paginationHtml = '';
			    var maxPageNumber = 5; // 한 번에 표시할 최대 페이지 수
			    var startPage = Math.max(0, currentPage - Math.floor(maxPageNumber / 2));
			    var endPage = Math.min(pageCount, startPage + maxPageNumber);

			    // '처음으로' 버튼 추가
			    if (currentPage > 0) {
			        paginationHtml += '<button class="pageButton" data-page="0">처음으로</button>';
			    }

			    // '이전' 버튼 추가
			    if (currentPage > 0) {
			        paginationHtml += '<button class="pageButton" data-page="' + (currentPage - 1) + '">이전</button>';
			    }

			    // 페이지 번호 버튼 생성
			    for (var i = startPage; i < endPage; i++) {
			        paginationHtml += '<button class="pageButton' + (i === currentPage ? ' active' : '') + '" data-page="' + i + '">' + (i + 1) + '</button>';
			    }

			    // '다음' 버튼 추가
			    if (currentPage + 1 < pageCount) {
			        paginationHtml += '<button class="pageButton" data-page="' + (currentPage + 1) + '">다음</button>';
			    }

			    // '마지막으로' 버튼 추가
			    if (currentPage + 1 < pageCount) {
			        paginationHtml += '<button class="pageButton" data-page="' + (pageCount - 1) + '">마지막으로</button>';
			    }

			    // 페이지네이션 HTML을 페이지네이션 컨테이너에 추가
			    $('.pagination').html(paginationHtml);
			}
			
			 // 전체 게시물 수를 가져오는 함수
			    function fetchTotalCount() {
			        $.ajax({
			            url: '/real-estate/count', // URL 수정
			            type: 'GET',
			            dataType: 'json',
			            success: function(response) {
			                createPagination(0, response, 10); // 첫 페이지 설정
			            },
			            error: function(error) {
			                console.log('전체 게시물 수를 가져오는데 에러가 발생했습니다:', error);
			            }
			        });
			    }
			
		    // 데이터를 가져오는 함수를 정의합니다.
		    function fetchRealEstateData(realEstateId,page, size) {
		        $.ajax({
		            url: '/real-estate/search',
		            type: 'GET',
		            dataType: 'json',
		            data: {
		            	realEstateId: realEstateId,
		                page: page,
		                size: size
		            },
		            success: function(realEstates) {
		                var realEstateListHtml = '';
		                realEstates.forEach(function(realEstate) {
		                    // 각 부동산 정보를 표시하는 HTML 마크업을 추가합니다.
		                    // 'complexName' 필드가 있는지 확인하고, 없으면 기본값을 사용합니다.
		                    var complexName = realEstate.realEstate && realEstate.realEstate.complexName ? realEstate.realEstate.complexName : '정보 없음';
		                    realEstateListHtml += '<div class="realEstateItem">' +
		                                          '<h4>' + complexName + '</h4>' +
		                                          // 다른 부동산 정보를 여기에 추가
		                                          '</div>';
		                });
		                $('.districtListContainer').html(realEstateListHtml);
		            },
		            error: function(error) {
		                console.log('부동산 정보를 가져오는데 에러가 발생했습니다:', error);
		            }
		        });
		    }

		    // #homeIcon 클릭 시 데이터를 가져오는 함수와 전체 게시물 수를 가져오는 함수를 호출합니다.
		    $('#homeIcon').click(function() {
		        fetchRealEstateData(0, 1, 10); // 첫 번째 페이지 데이터를 가져옵니다.
		        fetchTotalCount(); // 전체 게시물 수를 가져옵니다.
		    });

		    // 페이지 버튼 클릭 이벤트 핸들러
		    $('.pagination').on('click', '.pageButton', function() {
		        var selectedPage = $(this).data('page');
		        fetchRealEstateData(null, selectedPage, 10);
		    });
	        
	        
	        // 초기 페이지 로드 시 전체 게시물 수를 가져오고 페이지네이션을 생성합니다.
	        fetchTotalCount();
		});


	</script>
</body>
</html>
